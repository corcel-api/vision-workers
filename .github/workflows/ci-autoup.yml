name: Orchestrator AutoUpdates

on:
  push:

jobs:
  setup:
    name: Setup and Checkout
    runs-on: ubuntu-latest
    outputs:
      previous_tag: ${{ steps.get_tags.outputs.previous_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          tags: true
      
      - name: List all tags
        id: list_tags
        run: |
          git tag > tags.txt
          cat tags.txt
          if [ ! -s tags.txt ]; then
            echo "No tags found in the repository."
            exit 1
          fi
          TAGS=$(cat tags.txt)
          echo "tags=${TAGS[*]}" >> $GITHUB_ENV

      - name: Get the before latest tag (N-1)
        id: get_tags
        run: |
          TAGS=($(cat tags.txt))
          if [ ${#TAGS[@]} -lt 2 ]; then
            echo "Not enough tags to perform operation. Need at least two tags."
            echo "Available tags: ${TAGS[@]}"
            exit 1
          fi
          PREVIOUS_TAG=${TAGS[-2]}
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

      - name: Checkout to N-1 Tag
        run: git checkout ${{ steps.get_tags.outputs.previous_tag }}

  build:
    needs: setup
    name: Build Job
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ needs.setup.outputs.previous_tag }}
      
      - name: Build orchestrator with N-1 tag
        run: |
          echo "Building project tagged as ${{ needs.setup.outputs.previous_tag }}"